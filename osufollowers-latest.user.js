// ==UserScript==
// @name osu! followers
// @version 0.38
// @author Alvaro Daniel Calace
// @namespace https://github.com/alvarocalace/osufollowers
// @description Adds a new followed players section in your osu! profile
// @require http://code.jquery.com/jquery-latest.js
// @require http://timeago.yarp.com/jquery.timeago.js
// @include /osu.ppy.sh\/u\//
// @copyright 2015, Alvaro Daniel Calace
// @downloadURL https://raw.githubusercontent.com/alvarocalace/osufollowers/master/osufollowers-latest.user.js
// @grant GM_xmlhttpRequest
// ==/UserScript==

var u,URL_USER="https://osu.ppy.sh/u/",URL_BEATMAP="https://osu.ppy.sh/b/",URL_RANK="https://osu.ppy.sh/p/pp?c=",URL_BASE="http://itoon-osufollower.rhcloud.com",URL_API_SCORES="/api/FollowedPlayersRecentTopScores",URL_API_PLAYERS="/api/GetFollowedPlayers",URL_ADD="/AddFollowedPlayer",URL_DELETE="/DeleteFollowedPlayer",index=0,lock=0,pollingRate=10,defaultTimeout=7500;(function(){v()&&waitForSelector(".profileStatHeader:eq(1)",init,defaultTimeout)})();
function init(a){var b=$("<div>").attr("id","osuFollowersMainDiv");a.before(b);b.append(prepareTitleDiv());b.append(prepareScoresDiv());b.append(prepareShowMeMoreDiv());b.append("<br>");b.append(preparePlayersDiv());b.append(preparePlayersTableDiv());appendBatch();initPlayersTable()}
function prepareTitleDiv(){return $("<div>").attr("id","osuFollowersTitleDiv").addClass("profileStatHeader").append($("<a>").attr("href","https://itoon-osufollower.rhcloud.com/").attr("target","_blank").text("Followed Players"))}function prepareScoresDiv(){return $("<div>").attr("id","scoresDiv").css("overflow-y","auto").css("max-height","160px").append($("<table>").attr("id","scoresTable"))}
function prepareShowMeMoreDiv(){return $("<div>").attr("id","showMeMoreDiv").append($("<a>").attr("href","#").text("Show me more...").click(function(a){a.preventDefault();isLocked()||appendBatch()})).append($("<img>").attr("id","scoresLoadingIcon").attr("src","http://www.ajaxload.info/images/exemples/30.gif").css("height","11px").css("width","11px").hide())}function preparePlayersDiv(){return $("<div>").attr("id","playersDiv").append(prepareExpandPlayersButton()).append(preparePlayersInput())}
function prepareExpandPlayersButton(){return $("<a>").attr("id","expandPlayersButton").attr("href","#").click(function(a){a.preventDefault();a=$(this).children(":first");"none"===a.css("-webkit-transform")?a.css("-webkit-transform","rotate(-90deg)"):a.css("-webkit-transform","");a=$("#playersTableDiv");"none"===a.css("display")?a.show():a.hide()}).append($("<img>").attr("src","https://upload.wikimedia.org/wikipedia/commons/f/f7/Arrow-down-navmenu.png").css("padding-right","3px").css("height","11px").css("width",
"11px"))}function preparePlayersInput(){return $("<input>").attr("id","playersInput").attr("placeholder","follow a new player!").on("keydown",function(a){if(!isLocked()){var b=$(this).val();13===a.which&&b&&($(this).val(""),processAdd(b))}})}
function preparePlayersTableDiv(){return $("<div>").attr("id","playersTableDiv").css("padding-top","5px").append($("<table>").attr("id","playersTable").addClass("beatmapListing").attr("cellspacing","0").append($("<thead>").append($("<tr>").append($("<th>").text("Rank")).append($("<th>").text("Player")).append($("<th>").text("Accuracy")).append($("<th>").text("Playcount")).append($("<th>").text("Performance")).append($("<th>").text("Delete"))))).append($("<img>").attr("id","playersTableLoadingIcon").attr("src",
"http://www.ajaxload.info/images/exemples/30.gif").css("height","11px").css("width","11px").hide())}
function appendToScoresTable(a){$("#scoresTable").append($("<tr>").append($("<td>").css("width","20%").append($("<time>").addClass("timeago").attr("datetime",a.date).attr("title",formatDateForTitle(a.date)).text($.timeago(a.date)))).append($("<td>").append($("<div>").addClass("event epic1").append($("<img>").attr("src","/images/"+a.rank+"_small.png")).append(" ").append($("<a>").attr("href",URL_USER+a.username).attr("target","_blank").css("font-weight","bold").text(a.username)).append(" got ").append($("<span>").css("font-weight",
"bold").text(a.pp+"pp")).append(" on ").append($("<a>").attr("href",URL_BEATMAP+a.beatmap.beatmapId).attr("target","_blank").text(a.beatmap.artist+" - "+a.beatmap.title+" ["+a.beatmap.version+"]")).append(" ("+a.accuracy+" - "+modsToString(a.mods)+")"))))}
function appendToPlayersTable(a){var b=$("<td>").attr("href","#").css("text-align","center").click(function(b){b.preventDefault();if(!isLocked()&&confirm("Are you sure you want to stop following "+a.username+"?")){b=$(this).parent();var e=b.index();processDelete(a.username);b.remove();refreshPlayerTableRowClasses(e)}}).append($("<img>").attr("src","https://cdn2.iconfinder.com/data/icons/windows-8-metro-style/128/delete.png").css("width","10px").css("height","10px")),d=a.rank?"0"===a.rank?"unranked":
"#"+a.rank:"",e=a.country?a.country.toLowerCase():"mw",g=a.accuracy?a.accuracy:"",f=a.pp?"0"===a.pp?"unavailable":a.pp+"pp":"",h=a.playcount?commaSeparate(a.playcount):"";refreshPlayerTableRowClasses(appendInOrder($("<tr>").append($("<td>").css("font-weight","bold").text(d)).append($("<td>").append($("<a>").attr("href",URL_RANK+a.country).append($("<img>").attr("src","//s.ppy.sh/images/flags/"+e+".gif"))).append(" ").append($("<a>").attr("target","_blank").attr("href",URL_USER+a.username).text(a.username))).append($("<td>").text(g)).append($("<td>").text(h)).append($("<td>").css("font-weight",
"bold").text(f)).append(b),d))}function appendInOrder(a,b){var d=$("#playersTable"),e=d.find("tbody > tr");if(!e.length)return d.append(a),0;var g=parseInt(b.substring(1),10);if(!g)return d.append(a),e.length;var f;for(f=0;f<e.length;f++){var h=parseInt(e[f].firstChild.textContent.substring(1),10);if(!h||g<h)break}if(f<e.length)return e.eq(f).before(a),f;d.append(a);return e.length}
function processDelete(a){closeLock();var b=URL_BASE+URL_DELETE,d="username="+encodeURIComponent(u)+"&player="+encodeURIComponent(a),e=$("#playersTableLoadingIcon").show();createPostRequest(b,d,function(b){200===b.status?(showMessage("You have unfollowed "+a+"."),refreshScoresTable()):showMessage(b.responseText);e.hide();openLock()})}
function processAdd(a){closeLock();var b=URL_BASE+URL_ADD;a="username="+encodeURIComponent(u)+"&player="+encodeURIComponent(a);var d=$("#playersTableLoadingIcon").show();createPostRequest(b,a,function(a){200===a.status?(a=$.parseJSON(a.responseText),appendToPlayersTable(a),showMessage("You are now following "+a.username+"."),refreshScoresTable()):showMessage(a.responseText);d.hide();openLock()})}
function appendBatch(){closeLock();var a=URL_BASE+URL_API_SCORES+"?username="+encodeURIComponent(u)+"&startingIndex="+encodeURIComponent(index),b=$("#scoresLoadingIcon").show();createGetRequest(a,function(a){if(200===a.status){a=$.parseJSON(a.responseText);for(var e=0;e<a.length;e++)appendToScoresTable(a[e]),index++}else showMessage(a.responseText);a=$("#scoresDiv");a.stop().animate({scrollTop:a[0].scrollHeight},1E3);b.hide();openLock()})}
function initPlayersTable(){closeLock();var a=[],b=URL_BASE+URL_API_PLAYERS+"?username="+encodeURIComponent(u),d=$("#playersTableLoadingIcon").show();createGetRequest(b,function(b){if(200===b.status)for(a=$.parseJSON(b.responseText),b=0;b<a.length;b++)appendToPlayersTable(a[b]);else showMessage(b.responseText);d.hide();openLock()})}function refreshScoresTable(){$("#scoresTable").empty();index=0;appendBatch()}
function createGetRequest(a,b){GM_xmlhttpRequest({method:"GET",url:a,onload:function(a){b(a)}})}function createPostRequest(a,b,d){GM_xmlhttpRequest({method:"POST",url:a,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(a){d(a)}})}function showMessage(a){$("#messageSpan").remove();$("#playersDiv").append($("<span>").attr("id","messageSpan").css("padding-left","10px").css("color","#848484").text(a).fadeIn(400).delay(4E3).fadeOut(400))}
function refreshPlayerTableRowClasses(a){for(var b=$("#playersTable > tbody  > tr");a<b.length;a++)b[a].className=1===a%2?"row2p":"row1p"}function c(a){return(document.cookie.match("(^|; )"+a+"=([^;]*)")||0)[2]}function modsToString(a){for(var b="",d=0;d<a.length;d++)b+=a[d]+", ";return b.substring(0,b.length-2)}function waitForSelector(a,b,d){var e=0,g=setInterval(function(){var f=$(a);f.length?(clearInterval(g),b(f)):(e+=pollingRate,e>=d&&clearInterval())},pollingRate)}
function formatDateForTitle(a){var b=new Date(a),b=new Date(b.getTime()+6E4*b.getTimezoneOffset());a=b.getFullYear();var d=b.getMonth()+1,e=b.getDate(),g=b.getHours(),f=b.getMinutes(),b=b.getSeconds();return a+"-"+pad(d)+"-"+pad(e)+" "+pad(g)+":"+pad(f)+":"+pad(b)+" UTC"}function pad(a){return("0"+a).slice(-2)}function commaSeparate(a){for(;/(\d+)(\d{3})/.test(a.toString());)a=a.toString().replace(/(\d+)(\d{3})/,"$1,$2");return a}
function v(){var a=$(".profile-username").first().text().trim();if(a){if(u=c("last_login"))if(u=u.replace(/\+/g," "),u===a)return!0;u=$(".content-infoline").last().find("a").first().text();if(u===a)return!0}return!1}function isLocked(){return lock}function closeLock(){lock--}function openLock(){lock++};
